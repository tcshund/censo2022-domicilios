---
title: "Mapas - São Paulo/SP"
subtitle: "Indicadores domiciliares por setor censitário"
author: "Thais Cshunderlick"
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
format: 
  html:
    toc: true
engine: knitr
freeze: auto
execute:
  warning: false
  message: false
params:
  cod_mun: 3550308        # SP capital
  nome_mun: "São Paulo"
  ano_ref: 2022
  fonte: "IBGE - Censo Demográfico 2022"
editor_options: 
  chunk_output_type: inline
---

# Mapas de Indicadores

**Código IBGE do município:** `r params$cod_mun`\
**Ano de referência:** `r params$ano_ref`\
**Fonte:** `r params$fonte`

Este documento gera mapas interativos dos indicadores domiciliares do Censo 2022 para o município de **`r params$params$nome_mun`**. Os dados são visualizados por **setor censitário**, permitindo análises detalhadas intraurbanas.

## 1. Configuração do ambiente

```{r}
#| label: setup
#| warning: false
#| message: false

library(dplyr)
library(readr)
library(sf)
library(ggplot2)
library(geobr)
library(stringr)
library(viridis)
library(leaflet)
library(scales)
library(here)
library(DT)
```

```{r}
#| label: paths
# Definição da estrutura de pastas para organizar os dados 
pasta_base <- here("data") 
pasta_out <- sprintf("%s/03_indicators", pasta_base)
pasta_shapes <- sprintf("%s/04_shapes", pasta_base)
dir.create(pasta_shapes, recursive = TRUE, showWarnings = FALSE)
           
cn22dom_vars <- read_csv(
  file.path(pasta_out, "cn22dom_vars.csv"),
  show_col_types = FALSE
)

glimpse(cn22dom_vars)
```

```{r}
#| label: indicadores
# Carregar base de indicadores (criado na etapa 2)
indicadores <- cn22dom_vars %>%
  mutate(
    cod_setor = as.character(cod_setor),
    cod_municipio = as.character(cod_municipio)
  )
```

```{r}
#| label: filtro-mun
# Filtrar para o município
indicadores_mun <- indicadores %>%
  filter(cod_municipio == params$cod_mun) %>%
  mutate(cod_setor_ibge = cod_setor)

cat(
  "Setores em ",
  params$nome_mun,
  ": ",
  nrow(indicadores_mun),
  "\n\n",
  sep = ""
)

if (nrow(indicadores_mun) == 0) {
  stop("Nenhum setor encontrado para ", params$nome_mun)
}

cat("Primeiro setor: ", indicadores_mun$cod_setor[1], "\n", sep = "")
# os dois primeiros números do setor serão usados a seguir
```

## 2. Baixar e preparar shapes dos setores censitários

```{r}
#| label: baixar-shapes
#| cache: true
#| warning: false
shape_file <- file.path(pasta_shapes, paste0("setores_", params$cod_mun, ".gpkg"))
origem_shape <- NA_character_

# Checar se já foi baixado antes
if (file.exists(shape_file)) {

  cat("Usando shapes locais em cache...\n")
  setores_sf <- st_read(shape_file, quiet = TRUE)
  origem_shape <- "Cache local"

} else {
  cat("Shapes locais não encontrados.\n")
  cat("Baixando setores censitários via geobr...\n")

  tryCatch({
    setores_all <- read_census_tract(
       code_tract = params$cod_mun,
       year = 2019, # mais recente
       simplified = FALSE,
       showProgress = TRUE
    )

    # Filtrar UF de São Paulo (código começa com 35)
    setores_sp <- setores_all |>
      dplyr::filter(stringr::str_starts(as.character(code_muni), "35"))

    # Filtrar o município
    setores_sf <- setores_sp |>
      dplyr::filter(code_muni == as.numeric(params$cod_mun))

    if (nrow(setores_sf) == 0) {
      stop("Nenhum setor encontrado para o município ", params$cod_mun)
    }

    st_write(setores_sf, shape_file, quiet = TRUE)
    origem_shape <- "geobr_2019_filtrado_sp"

  }, error = function(e) {
    stop(
      "Erro ao obter shapes reais dos setores censitários.\n",
      "Detalhe: ", e$message
    )
  })
}

cat("Shapes carregados com sucesso.\n")
cat("Número de setores:", nrow(setores_sf), "\n")
cat("Origem dos dados:", origem_shape, "\n")
```

## 3. Juntar Dados e Geometrias

```{r}
#| label: juntar-dados-shapes
#| warning: false
# Converter código do setor para formato compatível
setores_com_dados <- setores_sf %>%
  mutate(
    code_tract_char = as.character(code_tract)
  ) %>%
  left_join(
    indicadores_mun,
    by = c("code_tract_char" = "cod_setor_ibge")
  )
```

## 4. Mapa 1: Proporção de apartamentos

### 4.1 Mapa interativo

```{r}
#| label: mapa-aptos
#| warning: false
# Selecionar indicadores
dados_mapa <- setores_com_dados %>%
  mutate(
    prop_aptos = dom03_apt_tot_2 * 100,
    prop_casas = dom03_cas_tot_2 * 100
  )

# Criar paleta de cores
criar_paleta <- function(variavel, cores = "YlOrRd", reversa = FALSE) {
  colorNumeric(
    palette = cores,
    domain = variavel,
    na.color = "#D6D6D6",
    reverse = reversa
  )
}
pal_aptos <- criar_paleta(dados_mapa$prop_casas, "YlOrRd")

# Criar mapa Leaflet
mapa_aptos <- leaflet(dados_mapa) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    fillColor = ~pal_aptos(prop_aptos),
    fillOpacity = 0.7,
    color = "#444444", 
    weight = 0.5,
    smoothFactor = 0.5,
    label = ~paste(
      "Setor:", code_tract_char,
      "<br>Aptos:", round(prop_aptos, 1), "%",
      "<br>Casas:", round(prop_casas, 1), "%"
    ) %>% lapply(htmltools::HTML),
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666666",
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    pal = pal_aptos,
    values = ~prop_aptos[!is.na(prop_aptos)],
    opacity = 0.7,
    title = "% de Apartamentos",
    position = "bottomright",
    labFormat = labelFormat(suffix = "%")
  ) %>%
  # Legenda separada para NA
  addLegend(
    colors = "#D6D6D6",
    labels = "Sem informação",
    opacity = 0.7,
    position = "bottomright"
  ) %>%
  addControl(
    paste(params$nome_mun, "- Proporção de Domicílios tipo Apartamento"),
    position = "topright"
  )

mapa_aptos
```

### 4.2 Mapa estático para exportação

```{r}
#| label: mapas-estaticos
#| warning: false
#| fig-width: 10
#| fig-height: 8
# Criar mapas estáticos com ggplot2

if (all(st_geometry_type(dados_mapa) %in% c("POLYGON", "MULTIPOLYGON"))) 
  {
  # Mapa: Proporção de casas
  mapa_estatico <- ggplot(dados_mapa) +
    geom_sf(aes(fill = prop_aptos), color = NA, size = 0.1) +
    scale_fill_distiller(
      name = "% Apartamentos",
      palette = "PuBu",      # Roxo-Azul 
      direction = 1,
      na.value = "gray90",
      labels = scales::percent_format(scale = 1)
      ) +
    labs(
      title = paste("Proporção de Domicílios tipo Apartamento -", params$nome_mun),
      subtitle = "Por setor censitário - Censo 2022",
      caption = "Fonte: IBGE - Censo Demográfico 2022"
    ) +
    theme_void() +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
      legend.position = "bottom",
      legend.key.width = unit(2, "cm")
    )
}
  print(mapa_estatico)
```

## 5. Mapa 2: Domicílios improvisados

```{r}
#| label: mapa2
dados_improvisados <- dados_mapa %>%
  mutate(prop_improvisados = dom02_dpio_tot_2 * 100)

# Calcular intervalos
q <- round(quantile(dados_improvisados$prop_improvisados[
  dados_improvisados$prop_improvisados > 0 & 
  !is.na(dados_improvisados$prop_improvisados)
], probs = seq(0, 1, 0.2), na.rm = TRUE), 1)

# Criar categorias
cats <- c(
  paste0("Acima de ", q[5], "%"),
  paste0(q[4], "% - ", q[5], "%"),
  paste0(q[3], "% - ", q[4], "%"),
  paste0(q[2], "% - ", q[3], "%"),
  paste0("0% - ", q[2], "%"),
  "0%",
  "Sem dados"
)

dados_improvisados <- dados_improvisados %>%
  mutate(
    categoria = case_when(
      is.na(prop_improvisados) ~ "Sem dados",
      prop_improvisados == 0 ~ "0%",
      prop_improvisados <= q[2] ~ paste0("0% - ", q[2], "%"),
      prop_improvisados <= q[3] ~ paste0(q[2], "% - ", q[3], "%"),
      prop_improvisados <= q[4] ~ paste0(q[3], "% - ", q[4], "%"),
      prop_improvisados <= q[5] ~ paste0(q[4], "% - ", q[5], "%"),
      TRUE ~ paste0("Acima de ", q[5], "%")
    ),
    categoria = factor(categoria, levels = cats)
  )

# Criar mapa
leaflet(dados_improvisados) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    fillColor = ~colorFactor(c("#8c2d04", "#d94801", "#f16913", "#fd8d3c", "#fdbe85", 
                               "#f0f0f0", "#cccccc"), categoria)(categoria),
    fillOpacity = 0.8,
    color = "#666666",
    weight = 0.3,
    label = ~paste("Setor:", code_tract_char,
                   "<br>Domicílios improvisados:", round(prop_improvisados, 2), "%") %>%
      lapply(htmltools::HTML)
  ) %>%
  addLegend(
    colors = c("#8c2d04", "#d94801", "#f16913", "#fd8d3c", "#fdbe85"),
    labels = cats[1:5],
    opacity = 0.8,
    title = "Domicílios Improvisados (2022)<br>(% em relação ao total)",
    position = "bottomright"
  ) %>%
  addLegend(
    colors = c("#f0f0f0", "#cccccc"),
    labels = c("0%", "Sem dados"),
    opacity = 0.8,
    position = "bottomright"
  ) %>%
  addControl(paste(params$nome_mun, "- Domicílios Improvisados"), position = "topright")
```

## 6. Análise por Distrito

```{r}
#| label: analise-distrital
#| warning: false

if ("nome_distrito" %in% names(indicadores_mun)) {
  
  distritos_agg <- indicadores_mun %>%
    group_by(cod_distrito, nome_distrito) %>%
    summarise(
      n_setores = n(),
      media_aptos = mean(dom03_apt_tot_2 * 100, na.rm = TRUE),
      media_casas = mean(dom03_cas_tot_2 * 100, na.rm = TRUE),
      media_improvisados = mean(dom02_dpio_tot_2 * 100, na.rm = TRUE),
      total_domicilios = sum(dom01_ocu_tot_1, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    filter(!is.na(nome_distrito) & nome_distrito != "") %>%
    mutate(
      ranking_aptos = rank(-media_aptos, ties.method = "first")
    ) %>%
    arrange(ranking_aptos)
  
  # Mostrar top 10
  top_aptos <- head(distritos_agg, 10)
  
  if (nrow(top_aptos) > 0) {
    ggplot(top_aptos,
           aes(x = reorder(nome_distrito, media_aptos), 
               y = media_aptos)) +
      geom_col(fill = "#74a9cf", alpha = 0.8) +
      geom_text(aes(label = paste0(round(media_aptos, 1), "%")), 
                hjust = -0.1, size = 3) +
      coord_flip() +
      labs(
        title = paste("Distritos com mais apartamentos -", params$nome_mun),
        subtitle = "Censo 2022",
        x = "Distrito",
        y = "% de Apartamentos"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(face = "bold"),
        axis.text.y = element_text(size = 9)
      )
  }
}
```

## 7. Tabela interativa com indicadores

```{r}
#| label: tabela-interativa
#| warning: false
if ("nome_distrito" %in% names(setores_com_dados)) {
  
  # Tabela agregada por distrito
  tabela_distritos <- setores_com_dados %>%
    st_drop_geometry() %>%
    group_by(Distrito = nome_distrito) %>%
    summarise(
      # Totais absolutos
      `Nº de casas` = sum(dom03_cas_tot_1, na.rm = TRUE),
      `Nº de aptos` = sum(dom03_apt_tot_0, na.rm = TRUE),
      # Proporções (média ponderada)
      `% Casas` = round(
        sum(dom03_cas_tot_1, na.rm = TRUE) / 
        sum(dom03_cas_tot_1 + dom03_apt_tot_0, na.rm = TRUE) * 100, 
        1
      ),
      `% Aptos` = round(
        sum(dom03_apt_tot_0, na.rm = TRUE) / 
        sum(dom03_cas_tot_1 + dom03_apt_tot_0, na.rm = TRUE) * 100, 
        1
      ),
      # Total de domicílios ocupados
      `Total Domicílios` = sum(dom01_ocu_tot_1, na.rm = TRUE)
    ) %>%
    filter(!is.na(Distrito) & Distrito != "") %>%
    # Ordenar por número de apartamentos (absoluto)
    arrange(desc(`Nº de casas`))
  
  # Tabela interativa
  datatable(
    tabela_distritos,
    options = list(
      pageLength = 15,
      dom = 'Blfrtip',
      buttons = c('copy', 'csv', 'excel'),
      language = list(
        search = "Filtrar distritos:",
        lengthMenu = "Mostrar _MENU_ distritos",
        info = "Mostrando _START_ a _END_ de _TOTAL_ distritos"
      )
    ),
    caption = paste("Distribuição de casas e aptos por distrito -", params$nome_mun),
    rownames = FALSE,
    filter = 'top'
  ) %>%
    formatStyle(
      '% Aptos',
      background = styleColorBar(c(0, 100), '#9ecae1'),
      backgroundSize = '98% 88%'
    ) %>%
    formatStyle(
      '% Casas',
      background = styleColorBar(c(0, 100), '#a1d99b'),
      backgroundSize = '98% 88%'
    ) %>%
    formatRound(columns = c('% Casas', '% Aptos'), digits = 1) %>%
    formatRound(columns = c('Nº de casas', 'Nº de aptos', 'Total Domicílios'), 
                digits = 0, mark = ".")  # Separador de milhar
} 
```

## Como usar para outros municípios

Para gerar mapas para outro município, renderize com parâmetros diferentes:

``` bash
# Rio de Janeiro
quarto render 03-mapa-cidades.qmd -P cod_mun:3304557 -P params$nome_mun:"Rio de Janeiro"

# Belo Horizonte
quarto render 03-mapa-cidades.qmd -P cod_mun:3106200 -P params$nome_mun:"Belo Horizonte"

# Curitiba
quarto render 03-mapa-cidades.qmd -P cod_mun:4106902 -P params$nome_mun:"Curitiba"
```

**Próximos passos:**\
1. Execute `01-import-data.qmd` para baixar os dados\
2. Execute `02-gerar-indicadores.qmd` para calcular indicadores\
3. Execute este documento para gerar os mapas\
4. Para publicar: `quarto render` e suba a pasta `docs/` para GitHub Pages

------------------------------------------------------------------------

*Documento gerado em `r format(Sys.time(), '%d/%m/%Y %H:%M')`*
